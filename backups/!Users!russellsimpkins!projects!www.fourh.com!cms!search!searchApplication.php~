<?php
/**
 * Russell Simpkins Software License
 *
 * Copyright Russell Simpkins 2010.  All rights reserved.
 * THIS PROGRAM IS AN UNPUBLISHED WORK AND TRADE SECRET OF THE COPYRIGHT HOLDER,
 * AND DISTRIBUTED ONLY UNDER RESTRICTION.
 *
 * No part of this program may be used, installed, displayed, reproduced,
 * distributed or modified without the express written consent of the copyright
 * holder.
 *
 * EXCEPT AS EXPLICITLY STATED IN A WRITTEN AGREEMENT BETWEEN THE PARTIES,
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED.  IN NO EVENT SHALL Russell Simpkins OR
 * ITS CONTRIBUTORS OR EMPLOYEES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
 * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * @author <a href='mailto:russellsimpkins@hotmail.com'>Russell Simpkins</a>
 *
 */
$path = "../";
include_once($path . "inc/global.inc.php");
$staticPath = BASE_SITE_PATH . "cms/";
if ( SECURE ) {
    include_once($path . "inc/secure.php");
}
include_once($path . "inc/db.config.php");
require_once($path . "inc/Paging.class.php");
require_once($path . "classes/Application.class.php");
$vars = array_merge($_GET,$_POST);
$db = new DBConfig();
$objApplication = new Application();
$orderby = (empty($vars['orderby'])) ? "1" : $vars['orderby'];
$query = (empty($vars['query'])) ? 0 : 1;
if ( empty( $vars['offset'] ) ) $vars['offset'] = 1;
if ( empty( $vars['go'] ) ) $vars['go'] = 10;
$go = $vars['go'];
if (!empty($vars['application_id'])) {
    foreach ($vars['application_id'] as $id) {
        $objApplication->delete( $id );
    }
}
$sql = "";
$where = "";
if ( !empty( $vars['do'] ) ) {
    if ( !empty( $vars['searchText'] ) ) {
        $stmt = $objApplication->util->wrap( '%' . $vars['searchText'] . '%' );
        if ( !empty( $vars['first_name'] ) ) {
            if ( strlen( $where ) > 5 ) $where .= " and ";
            $where .= "first_name like " . $stmt;
        }
        if ( !empty( $vars['middle_initial'] ) ) {
            if ( strlen( $where ) > 5 ) $where .= " and ";
            $where .= "middle_initial like " . $stmt;
        }
        if ( !empty( $vars['last_name'] ) ) {
            if ( strlen( $where ) > 5 ) $where .= " and ";
            $where .= "last_name like " . $stmt;
        }
        if ( !empty( $vars['my_title'] ) ) {
            if ( strlen( $where ) > 5 ) $where .= " and ";
            $where .= "my_title like " . $stmt;
        }
        if ( !empty( $vars['dob'] ) ) {
            if ( strlen( $where ) > 5 ) $where .= " and ";
            $where .= "dob like " . $stmt;
        }
    }
    if ( empty( $where ) ) {
        $sql = "select application_id id from " . $db->getPrefix() . "application order by " . $orderby;
    } else {
        $sql = "select application_id id from " . $db->getPrefix() . "application where " . $where . " order by " . $orderby;
    }
} else {
    $sql = empty( $vars['search'] ) ? "" : stripslashes(urldecode($vars['search']));
    $where = empty( $vars['where'] ) ? "" : stripslashes(urldecode($vars['where']));
    if ( empty( $sql ) ) {
        if ( empty( $where ) ) {
            $sql = "select application_id id from " . $db->getPrefix() . "application order by " . $orderby;
        } else {
            $sql = "select application_id id from " . $db->getPrefix() . "application where " . $where . " order by " . $orderby;
        }
    }
}
$pg = new Paging();
if ( !empty( $sql ) ) {
    $data = $pg->search( $sql, $vars );
}
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Search Application</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link href="<?=$staticPath?>css/site.css" rel="stylesheet" type="text/css">
<script language="javascript" type="text/javascript" src="<?=$staticPath?>inc/global.js"></script>
<script language="javascript" type="text/javascript" src="<?=$staticPath?>js/common.js"></script>
<script language="javascript" type="text/javascript">
<!--//
function checkem( item ) {
    name = item.form.name;
    document.forms[ name ].first_name.checked = true;
    document.forms[ name ].middle_initial.checked = true;
    document.forms[ name ].last_name.checked = true;
    document.forms[ name ].my_title.checked = true;
    document.forms[ name ].dob.checked = true;
}
function clearem( item ) {
    name = item.form.name;
    document.forms[ name ].first_name.checked = false;
    document.forms[ name ].middle_initial.checked = false;
    document.forms[ name ].last_name.checked = false;
    document.forms[ name ].my_title.checked = false;
    document.forms[ name ].dob.checked = false;
}
/**
 * This function submits the form to do the delete.
 **/
function del(tform) {
    if ( confirm("Are you certain? This cannot be undone.") ) {
        tochange = getAnObject('delete');
        tochange.value=1;
        tform.action="<?=$_SERVER['PHP_SELF']?>";
        var index = 0;
        for ( i = 0;i< document.forms.length;++i) {
            if (document.forms[i].name == tform) {
                index = i;
                break;
            }
        }
        document.forms[index].submit();
    }
}
//-->
</script>
</head>
<body>
<div id="wrapper" name="wrapper" class="wrapper">
<?php include_once($path . "inc/branding.bar.inc.php"); ?>
<?php include_once($path . "inc/admin-leftnav.inc.php"); ?>
<div class="headerblock" id="header">
    <table class="headerform" width="539" border="0" cellpadding="0" cellspacing="0">
        <tr>
            <td class="searchfields">&nbsp;&nbsp;<a href="<?=$path?>edit/editApplication.php"><img src="<?=$staticPath?>img/new.png" border="0" width="16" height="16" alt="add new Application" title="add new Application"></a>
            <span class="header">Search for Application</span><br></td>
            <td class="searchfields">&nbsp;</td>
            </tr>
            <tr>
            <td colspan="2" nowrap="yes" class="blkText">
            <form class="searchdata" name="search" action="<?=$PHP_SELF?>"><input type='checkbox' name='first_name' value='1' <? if ( !empty( $vars['first_name'] ) ) echo 'checked=\'yes\'';?>>First name<input type='checkbox' name='middle_initial' value='1' <? if ( !empty( $vars['middle_initial'] ) ) echo 'checked=\'yes\'';?>>Middle initial<input type='checkbox' name='last_name' value='1' <? if ( !empty( $vars['last_name'] ) ) echo 'checked=\'yes\'';?>>Last name<input type='checkbox' name='my_title' value='1' <? if ( !empty( $vars['my_title'] ) ) echo 'checked=\'yes\'';?>>My title&nbsp;<input type="text" name="searchText" size="10"><input type="submit" name="search" value="go" class="save-button">
            <input type="radio" name="all" onClick="checkem(this)">all
            <input type="radio" name="all" onClick="clearem(this)">none
            <input type="hidden" name="do" value="1"</form></td>
        </tr>
    </table>
</div>
<?php if (!empty($data)) { ?>
<div class="searchblock" id="searchblock"> 
    <table class="searchform" width="539" border="0" cellpadding="0" cellspacing="0">
        <tr> 
            <td align="left" valign="top"><form method="get" action="<?=$path?>search/searchApplication.php" name="searchControl" class="searchdata">
            <input type="hidden" name="delete" value="0">
                <table width="100%" border="0" cellpadding="0" cellspacing="0">
					<tr>
                        <td colspan='7' class='spacer'><img src='<?=$staticPath?>img/spacer.gif' height='1' width='539'></td>
                    </tr>
                    <tr> 
                        <td colspan='7'>&nbsp;</td>
                    </tr>
                    <tr align="center"> 
                        <td class='tablemenu'>&nbsp;<strong>Select</strong></td>
                        <td class='tablemenu' nowrap='true'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'application_id') ? 'application_id desc' : 'application_id'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by ID Number</a>&nbsp;</td>
                        <td class='tablemenu'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'my_title') ? 'my_title desc' : 'my_title'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by My title</a></td>
                        <td class='tablemenu'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'first_name') ? 'first_name desc' : 'first_name'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by First name</a></td>
                        <td class='tablemenu'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'last_name') ? 'last_name desc' : 'last_name'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by Last name</a></td>
                        <td class='tablemenu'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'email') ? 'email desc' : 'email'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by Email</a></td>
                        
                        <td class='tablemenu'><a href='<?=$PHP_SELF?>?orderby=<?= ($orderby == 'email') ? 'email desc' : 'email'?>&amp;query=1&amp;go=<?=$go?>&amp;where=<?=urlencode( $where ) ?>'>Sort by Status</a></td>
                    </tr>
                    <tr> 
                        <td colspan='7'>&nbsp;</td>
                    </tr>
					<tr> 
                        <td colspan='7' class='spacer'><img src='<?=$staticPath?>img/spacer.gif' height='1' width='539'></td>
                    </tr>
                    <?php
                    $bgcolor[0]="lightrow";
                    $bgcolor[1]="darkrow";
                    $dollaridx = 0;
                    foreach ($data as $id) {
                        $objApplication->loadById( $id['id'] );
                    ?>
                    <tr class="<?=$bgcolor[($dollaridx++%2)]?>">
                        <td width='60' class='tabledata' nowrap='true'><input type='checkbox' name='application_id[]' value='<?=$objApplication->getApplicationId()?>'></td>
                        <td class='tabledata' nowrap='true'><a href='<?=$path?>edit/editApplication.php?application_id=<?=$objApplication->getApplicationId()?>'><?=$objApplication->getApplicationId()</a></td>
                        <td class='tabledata'><?=$objApplication->getTitle()?></td>
                        <td class='tabledata'><?=$objApplication->getFirstName()?></td>
                        <td class='tabledata'><?=$objApplication->getLastName()?></td>
                        <td class='tabledata'><?=$objApplication->getEmail()?></td>
                        <td class='tabledata'>Member</td>
                    </tr>
                    <?
                    }
                    ?>
					<tr> 
                        <td colspan='7' class='spacer'><img src='<?=$staticPath?>img/spacer.gif' height='1' width='539'></td>
                    </tr>
                </table></form><table width="100%" border="0" cellspacing="0" cellpadding="5" class="lightrow">
                    <tr> 
                        <td>
                        <a href="javascript:del( 'searchControl' )"><img src="<?=$staticPath?>img/delete-button.png" border="0" alt="click to delete selected" title="click to delete selected"></a>
                        </td>
                        <td>&nbsp;</td>
                        <td align="right"><?php $pg->writeNavigation( "searchApplication.php", $sql, array("query"=>1,"where"=>$where) ); ?>
                            <form method="get" action="<?=$PHP_SELF?>" class="searchdata">
                        <input type="hidden" name="query" value="1">
                        <input type="hidden" name="search" value="<?=urlencode($sql)?>">
                        <input type="hidden" name="where" value="<?=urlencode($where)?>">
                        <input type="hidden" name="go" value="1">
                            <select name="go">
                                <option<?php if (!empty($vars['go']) && $vars['go']==10) echo " selected=\"yes\" "?>>10</option>
                                <option<?php if (!empty($vars['go']) && $vars['go']==25) echo " selected=\"yes\" "?>>25</option>
                                <option<?php if (!empty($vars['go']) && $vars['go']==50) echo " selected=\"yes\" "?>>50</option>
                            </select>
                            <input type="image" name="doit" value="u" src="<?=$staticPath?>img/apply.png" height="16" width="16">
                            </form></td>
                    </tr>
                </table></td>
        </tr>
    </table>
</div>
<?php } ?>
<div class="instructionblock" id="instructions"> 
    <table class="instructionform" border="0" cellpadding="0" cellspacing="0">
        <tr> 
            <td align="left" valign="top">
            <strong><b>HOW TO USE THIS PAGE.</b></strong>
            <p>This is the search screen. Use this screen to search through all
            Application assets you have. If there are no assets, the the screen will appear 
            empty. 
            <ul>
            <li>
            To add new Application, click the '+' on the left navigation.</li>
            <li>You will notice a checkbox and a delete button at the bottom
            of the screen, if you have any assets to view.</li>
            <li>At the bottom right hand of the screen is the paging
            feature. Use that to page your Application elements.
            </li></ul></p></td>
        </tr>
    </table>
</div>
</html>
