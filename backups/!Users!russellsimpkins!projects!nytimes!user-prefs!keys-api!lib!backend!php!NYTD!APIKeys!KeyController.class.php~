<?php

/**
 * This class is here to controll which methods are called based on 
 * the request uri
 */
class NYTD_User_Prefs_APIKey_Controller {

  /**
   * Our default constructor
   */
  public function __constructor(&$params) {
    $this->params = $params;
  }

  /**
   * Here is where you map requests to methods. Each method should
   * call Models to do the real work.
   */
  public function handleRequest() {
    if (preg_match("/^\/svc\/v3\/up\/apikeys\/validate",$_SERVER['REQUEST_URI'])) 
      return $this->isKeyValid();
    if (preg_match("/^\/svc\/v3\/up\/apikeys\/exists",$_SERVER['REQUEST_URI'])) 
      return $this->doesKeyExist();
    if (preg_match("/^\/svc\/v3\/up\/apikeys\/expiring",$_SERVER['REQUEST_URI'])) 
      return $this->isKeyExpiring();
    if (preg_match("/^\/svc\/v3\/up\/apikeys\/renew",$_SERVER['REQUEST_URI'])) 
      return $this->renewKey();
    if (preg_match("/^\/svc\/v3\/up\/apikeys\/expire",$_SERVER['REQUEST_URI'])) 
      return $this->expireKey();
  }

  /**
   * Call the validator to validate the call
   */
  public function isKeyValid() {
    if (empty($params)) return false;
    $validator = new NYTD_UserPrefs_APIKeys_Validator();
    $args = $this->parsePathForParams($params,5,true,';');
    $result = $validator->validate($args[0][0], $args[0][1], false);
    $this->sendResponse($result);
  }

  /**
   * Call the generator to verify the account does exist
   */
  public function doesKeyExist() {
    if (empty($params)) return false;
    $args = $this->parsePathForParams($params);
    $generator = new NYTD_UserPrefs_APIKeys_Generator();
    $result = $generator->accountExists($args[0]);
    $this->sendResponse($result);
  }

  /**
   * Call the generator to check if the key is expiring soon
   */
  public function isKeyExpiring() {
    if (empty($params)) return false;
    $args = $this->parsePathForParams($params);
    $generator = new NYTD_UserPrefs_APIKeys_Generator();
    $result = $generator->isKeyExpiring($args[0]);
    $this->sendResponse($result);
  }

  /**
   * Call the generator to renew this account
   */
  public function renewKey() {
    if (empty($params)) return false;
    $args = $this->parsePathForParams($params);
    $generator = new NYTD_UserPrefs_APIKeys_Generator();
    $result = $generator->renewKey($args[0]);
    $this->sendResponse($result);
  }

  /**
   * Call the generator to ternimate this account
   */
  public function terminateKey() {
    if (empty($params)) return false;
    $args = $this->parsePathForParams($params);
    $generator = new NYTD_UserPrefs_APIKeys_Generator();
    $result = $generator->terminateKey($args[0]);
    $this->sendResponse($result);
  }

  /**
   * Encapsulate the sending of responses.
   */
  public function sendResponse( &$result ) {
    $response = new NYTD_UserPrefs_APIKeys_Response();
    $response->sendResponse();
  }

  /**
   * A utility to get params out of the path - we need this to do
   * restful requests where the data we need is buried into the
   * request uri. 
   *
   * @param uri String the full request uri e.g. /svc/person/get/123
   * @param numPathParts integer a count of the path parts e.g. 3 given the
   *        uri /svc/person/get/123
   * @param paramsHaveParts Boolean true means you have .../get/12;34;32;54;31
   * @param separator String the parts separator e.g. ;
   */
  public function parsePathForParams( &$uri, 
                                      $uriEndsAt=5, 
                                      $paramsHaveParts=false, 
                                      $separator=';' ) {
    $parts = explode($uri,'/');
    /**
     * Given uriEndsAt, we can grab all params after uriEndsAt
     * to build our return array.
     */
    $parts = array_slice(($uriEndsAt+1));
    $retval = array();
    foreach ($parts as $var) {
      if ($paramsHaveParts) {
        $retval[] = explode($var,$separatr);
      } else {
        $retval[] = $var;
      }
    }
    return $retval;
  }
}