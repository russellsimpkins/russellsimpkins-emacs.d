<?php

nytd_require("NYTD/Util/XmlSerializer.class.php");
nytd_require("NYTD/DomDocument.class.php");

/**
 * This class encapsulates our HTTP response
 */
class NYTD_UserPrefs_APIKeys_Response {

    private $logger;
    private $response_format;

    /**
     * The default constructor
     *
     * @param result Hash the hash of data to send in the response.
     * @param responseCode Integer HTTP response code number e.g. 404
     */
    public function __construct($result, $responseCode=200) {
        $this->logger = NYTD_Logger_Web::getInstance('user');
        $this->logger->setLevel(255);
        $this->setResponseFormat($_SERVER['REQUEST_URI']);
        if ($this->response_format == 'xml') {
            if (is_null($doc)) 
                $doc = new NYTD_DomDocument();
            $node = $doc->createElement('response');
            $this->buildXml($doc, $node, $result);
            $xml = new NYTD_Util_XmlSerializer(array());
            $xml->serialize($result, $node);
            $doc = $node->ownerDocument;
            $doc->appendChild($node);
            $body = $doc->saveXml();
        } else {
            $body = json_encode($result);
        }
        // print our headers
        header("Content-Length: " . strlen($body) . "");
        header(NYTD_UserPrefs_APIKeys_Config::$RESPONSE_MESSAGE[$responseCode]);
        print $body;
        exit;
    }
    
    /**
     * This function will determine what response format we need to use
     *
     * @param url String the uri to base the format on
     */
    private function setResponseFormat($uri) {
        $format_pattern = '/\.(json|xml)$/i';
        if (preg_match($format_pattern, $uri, $matches)) {
            $this->response_format = strtolower(trim($matches[1]));
        } else {
            $this->response_format = 'json';
        }
    }

    /**
     * This function encapsulates the logic to send an 
     * xml formatted response
     *
     * @param doc Object an instance of DomDocument
     * @param node Object a document node
     * @Param data Object the data to add to the node
     */
    public function buildXml($doc, $node, $data) {
        $keys = array_keys($data);
        foreach ($keys as $key) {
            $top_attribute = "";
            $this->logger->debug("key is " . $key);
            if (is_numeric($key)) {
                $iter_key = $node->tagName;
                $iter_key = preg_replace('/s$/',"",$iter_key);
                $this->logger->debug("iiteration key is " . $iter_key);
                $top_attribute = $doc->createElement($iter_key);
            } else {  
                $top_attribute = $doc->createElement($key);
            }
            if (is_array($data[$key])) {
                $this->buildXml($doc, $top_attribute, $data[$key]);
            } else {
                $top_attrib_txt = $doc->createTextNode($data[$key]);
                $top_attribute->appendChild($top_attrib_txt);
                $node->appendChild($top_attribute);
            }
        }
    }
} // end of class
?>
