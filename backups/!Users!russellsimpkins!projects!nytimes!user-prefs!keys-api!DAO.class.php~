<?php
// bring in dbslayer
nytd_require("NYTD/DBSlayer/Connection.class.php");
/**
 * This is the base, core dao for our classes to execute SQL 
 * using dbslayer
 */
class NYTD_UserPrefs_APIKeys_BaseDAO {

  /**
   * Our default constructor - set's up the logger and the env var
   */
  public function __construct() {
    $this->env = get_cfg_var('nytcontext.servertype');
    if(empty($this->env))
      $this->env = "production";
    
    $this->logger = NYTD_Logger_Web::getInstance();
    if($this->env == 'development') { 
      $this->logger->setLevel(255);
    }

    $this->cache = new Memcache;
    $configArr = NYTD_UserPrefs_APIKeys_Config::$MEMCACHE_CONFIG[$this->env];
    if (count($configArr) == 0) {
      $logger->debug("No Memcache configuration for $this->env environment found in config.");
    } else {
      for ($i = 0; $i < count($configArr); ++$i) {
        $current = $configArr[$i];
	    $this->logger->debug("Adding server: {$current['host']} {$current['port']}");
	    $this->cache->addServer($current["host"], $current["port"], $current["persistent"]);
      }
    }
  }

  /**
   * One function to execute SQL with.
   * @param $sql - statement to be executed 
   * @param $params - params to be passed during statement preparation
   * @param $multipleRes - true if sql returns more than one row.
   *
   */
  protected function executeDBQuery($sql, $param=null, $multiRows=false, $daemon=null) {
    if(empty($daemon)) {
       $this->dbh = new NYTD_DBSlayer_Connection(NYTD_UserPrefs_APIKeys_Config::DBSLAYER_MASTER, $this->logger, 
                                                      array(NYTD_DBSlayer_Connection::FL_DISABLE_DATE_CONVERSION), true);
    } else {
      $this->dbh = new NYTD_DBSlayer_Connection($daemon, $this->logger, array(NYTD_DBSlayer_Connection::FL_DISABLE_DATE_CONVERSION), true);
    }
    if (empty($param)) {
      $param = array();
    }
    try {
      $result = array();
      $sth = $this->dbh->safePrepare($sql, $param);
      if (!$sth->execute()) {
         throw new Exception('NYTD_UserPrefs_APIKeys_BaseDAO: Error Executing sql: (' . $sth->errorCode() . ' ): ' . $sth->errorMessage());
      }
      $res = $sth->fetchRowArray();
      if ($multiRows) {
        $result[] = $res;
        while ($sth->nextResults()) 
          $result[] = $sth->fetchRowArray();
      } else {
        $result = $res;
      }
  
    } catch (Exception $e) {
      $this->logger->error('NYTD_UserPrefs_APIKeys_BaseDAO: Problem Executing $sql: ' . $e->getMessage());
      throw $e;
      return false;
    }
    return $result;
  }
}
?>